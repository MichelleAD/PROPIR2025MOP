---
output: 
  bookdown::html_document2:
    theme: united
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: false
lang: es
css: styles.css
---

```{=html}
<style>
  .section {
    border-top: 2px solid black;
    margin-top: 20px;
    padding-top: 10px;
  }
</style>
```

<div class="Análisis Análisis Descriptivo de Ante-Proyecto 
de Ley 2025 MOP">
  <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 100px;">Análisis Descriptivo de Ante-Proyecto 
de Ley 2025 MOP</div>
  <div style="text-align: center;">
  <img src="mop.jpeg" alt="Descripción de la imagen" width="30%">
</div>
  <div style="font-size: 1.5em; color: black; margin-top: 100px;">Unidad Gestión del Conocimiento y Tecnología</div>
  <div class="fecha">`r format(Sys.Date(), '%d de %B de %Y')`</div>
</div>


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
options(knitr.fig.caption = TRUE)
knitr::opts_knit$set(lang = "es")
knitr::opts_chunk$set(fig.cap = "Figura ")
```

```{r, include=FALSE}
library(knitr) ; library(kableExtra); library(ggplot2); library(tinytex); library(dplyr); library(scales); library(readxl); library(paletteer); library(viridis); library(gridExtra); library(ggrepel); library(htmltools)
Sys.setlocale("LC_ALL", "es_ES.UTF-8") 
```

```{r}

#####################################################################################################

#Este es un análisis previo, para dejar la base de datos con el mismo formato de nombres de variables
#y categorizaciones de los respectivos gráficos


#####################################################################################################


# En esta sección, hice un vector de categorías 
# para que después en las tablas y gráficos
# las regiones se vean ordenadas de 1-17(esta última es
# interregional)

#el orden_regiones es el orden de las regiones pero para los gráficos, mientras que 
#orden_regiones_tab es el orden para las tablas. Todo esto con el fin #de que tenga el orden del mapa de chile



orden_regiones <- c("INTERREGIONAL","MAGALLANES","AYSÉN","LOS LAGOS","LOS RÍOS","LA ARAUCANÍA","BIOBÍO","ÑUBLE","MAULE",
                    "O'HIGGINS", "METROPOLITANA","VALPARAÍSO","COQUIMBO","ATACAMA","ANTOFAGASTA","TARAPACÁ","ARICA Y PARINACOTA")




PROYECCIONES_POBmulti <- read_excel("PROYECCIONES_POBmultiPROPIR.xlsx")



BASE <- read_excel("BASE_PROPIR.xlsx")
 
 
 #############################################
 # Añadiendo la Abreviación de los servicios #
 #############################################


#para el cambio hay que fijarse bien si los nombres del servicios #corresponden a estos, o si se agregaron nuevos. Si es así, añadirlos #en el case_when


BASE <- BASE %>% mutate(Servicio = case_when(Servicio == "Dirección de Arquitectura" ~ "DA",
                                              Servicio == "Dirección de Obras Hidráulicas" ~ "DOH",
                                              Servicio == "Dirección de Vialidad" ~ "DV",
                                              Servicio == "Dirección de Obras Portuarias" ~ "DOP",
                                              Servicio == "Dirección de Aeropuertos" ~ "DAP",
                                              Servicio == "Dirección de Planeamiento" ~ "DP",
                                Servicio == "Subdirección de Servicios Sanitarios Rurales" ~ "SSR",
                Servicio == "Conservaciones por Administración Directa - Dirección de Vialidad"  ~ "DV",
            Servicio == "Conservaciones por Administración Directa - Dirección de Aeropuertos" ~ "DAP",
            Servicio == "Dirección General de Concesiones de Obras Públicas" ~ "DGC",
                                              Servicio == "Dirección General de Aguas" ~ "DGA",
            Servicio == "Gestión Hídrica y Organizaciones-DGA" ~ "DGA",
            Servicio == "Instituto Nacional de Hidráulica"  ~ "INH",
            Servicio == "Superintendencia de Servicios Sanitarios" ~ "SISS"))
 
 
#este cambio es solo para nacional
BASE <- BASE %>%
  mutate(SERVICIOS_A = case_when(
    Servicio %in% c("INH", "SISS", "DP", "DGA", "DA") ~ "OTROS",
    TRUE ~ Servicio
  ))


prop2024 <- read_excel("PROPIR-2024.xlsx", sheet="Hoja2")


prop2024 <- prop2024 %>% mutate(RegionAB = case_when(
                                             REGION == "1" ~  "TARAPACÁ",
                                             REGION == "3" ~ "ATACAMA",
                                             REGION == "2" ~ "ANTOFAGASTA",
                                             REGION == "4" ~ "COQUIMBO",
                                             REGION == "5" ~ "VALPARAÍSO",
                                             REGION == "6" ~ "O'HIGGINS",
                                             REGION == "7" ~ "MAULE",
                                             REGION == "16" ~ "ÑUBLE",
                                             REGION == "8" ~ "BIOBÍO",
                                             REGION == "9" ~ "LA ARAUCANÍA",
                                             REGION == "10"  ~ "LOS LAGOS",
                                             REGION == "11" ~ "AYSÉN",
                                             REGION == "12"  ~ "MAGALLANES",
                                             REGION == "RM" ~  "METROPOLITANA" ,
                                             REGION == "14" ~ "LOS RÍOS",
                                             REGION == "15"  ~ "ARICA Y PARINACOTA",
                                             TRUE ~ "INTERREGIONAL"
)) %>% select(RegionAB, INV2024)



#esta parte, necesariamente arreglarla todos los años porque puede que
#se agreguen nuevos campos, por lo que es necesario categorizarlos.


aguasSH <- BASE %>% filter(Categoría == "Nuevo") %>% filter(`Eje Ministerial` == "Seguridad hídrica")



BASE <- BASE %>%  
  mutate(AGUA_DIPRES = case_when(PROGRAMA == "GRANDES OBRAS DE RIEGO" ~ "RIEGO",
               PROGRAMA == "CONSERVACION DE OBRAS DE RIEGO" ~ "RIEGO",
               PROGRAMA == "CONSERVACION DE SISTEMAS SANITARIOS RURALES" ~ "CONSUMO HUMANO",
               PROGRAMA == "AMPLIACION Y MEJORAMIENTO DE SERVICIOS EXISTENTES DE AGUA POTABLE RURAL" ~ "CONSUMO HUMANO",
               PROGRAMA == "AGUA POTABLE RURAL DISPERSO" ~ "CONSUMO HUMANO",
               PROGRAMA == "REDES DE MEDICION" ~ "GESTIÓN",
               PROGRAMA == "ANALISIS Y EVALUACIÓN" ~ "GESTIÓN",
             PROGRAMA ==  "OBRAS MEDIANAS DE RIEGO" ~ "RIEGO",
           PROGRAMA ==  "EXPLOTACION DE OBRAS DE RIEGO" ~ "RIEGO",
          PROGRAMA ==  "OBRAS DE RIEGO" ~ "RIEGO",
          PROGRAMA == "AGUA POTABLE RURAL SEMI CONCENTRADO" ~ "CONSUMO HUMANO",
          PROGRAMA == "AGUA POTABLE RURAL CONCENTRADO" ~ "CONSUMO HUMANO",
          PROGRAMA == "CONSTRUCCION" ~ "ESTUDIOS Y OTROS",
          PROGRAMA == "RECONSTRUCCION" ~ "ESTUDIOS Y OTROS",
       PROGRAMA == "ESTUDIOS" ~ "ESTUDIOS Y OTROS"))


```

## Introducción

El Programa Público de Inversión (PROPIR), detalla la información de los comprometido y aprobado a realizar cada año en las Regiones. En este documento se presentan las estadísticass de los Servicios del Ministerio de Obras Públicas que se están ejecutando o tienen programado a ejecutar durante este año 2025.

Este análisis descriptivo tiene como objetivo describir el PROPIR del presente año 2025 para así ver cómo se distribuye la inversión a lo largo del paós y sumarlo a los instrumentos de análiss para el proceso de planificación. Este análisis descriptivo se divide en tres secciones, una a nivel nacional, otra para cada región y otra para aquellos proyectos interregionales.

Se presentarán tablas y gráficos en cada sección que se visualizan datos relevantes, los cuales mayormente son de inversión, y además se presentan gráficos históricos por sección para analizar tendencias y patrones y de acuerdo a estos hacer posibles inferencias en los datos, para el año 2025.

## Nacional

El análisis de la "Figura 1" muestra que el crecimiento relativo de la inversión PROPIR en 2025 respecto a 2024 es positivo en 14 de las 16 regiones del país. Regiones como Tarapacá (1.73), Los Ríos (1.32) y Los Lagos (1.28) presentan los mayores incrementos, mientras que regiones como Atacama, Maule, y los Proyectos Interregionales tienen un decrecimiento en comparación a la inversión del 2024.

```{r}
orden_regiones_tab <- rev(orden_regiones)


tab1 <- BASE %>% group_by(RegionAB) %>% summarise("Monto 2025" = sum(`Monto 2025`)) %>% left_join(prop2024, by="RegionAB") %>% 
  mutate(
    RegionAB = factor(RegionAB, levels = orden_regiones)
  )  %>% arrange(RegionAB) 




tab1 <- tab1 %>%
  mutate(
    IncDec = round(`Monto 2025` / INV2024, 2),  
    Flecha = case_when(
      IncDec > 1 ~ "↑",  
      IncDec < 1 ~ "↓",  
      TRUE ~ "="         
    ),

    Label = paste0(
      scales::comma(`Monto 2025`, big.mark = ".", decimal.mark = ","),  
      "   ",  
      "<span style='color:red;'>", Flecha, "</span>",
      "   (", scales::comma(IncDec, big.mark = ".", decimal.mark = ","), ")"  
    )
  )



#tab1 %>%
#  mutate(`Monto 2025` = scales::comma(`Monto 2025`, big.mark = ".", decimal.mark = ",")) %>%
#  kable(caption = paste(" Resúmen del monto presupuestario de 2025 por región"), col.names = #c("Región","Monto 2025 (Miles de millones)")) %>%
#  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F) 
  

```

```{r, fig.cap=NULL}


ggplot(tab1, aes(y = RegionAB, x = `Monto 2025`)) +
  geom_bar(stat = "identity", fill = "darkblue", width = 0.6) +
  theme_minimal() +

  ggtext::geom_richtext(aes(label = Label), 
                        hjust = -0.1, size = 3, 
                        fill = NA, label.color = NA) + 
  scale_x_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"), 
    limits = c(0, 636729160),
    breaks = seq(0, 506729160, by = 100000000)) +
  labs(
    title = "Inversión 2025 a nivel Regional e Interregional",
    x = "Inversión PROPIR 2025 (miles de pesos)",  
    y = "",
    caption =  "Figura 1: Inversión PROPIR 2025 a nivel Regional e Interregional.\nFuente: Elaboración propia basada en datos del Departamento de Gestión Presupuestaria.\nNota: Flecha hacia arriba/abajo indica crecimiento/decrecimiento en comparación al presupuesto del año 2024 y entre\n paréntesis el factor de crecimiento/decrecimiento."
  ) +
   theme(
     panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),  
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-150)),
    axis.text.x = element_text(vjust = -0.3), 
    axis.text.y = element_text(size = 10, margin = margin(r = 20)),  
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10, margin = margin(r = 20)),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )


```

La "Tabla 1" muestra la distribución de la inversión PROPIR 2025 en relación con la población proyectada, el crecimiento demográfico y la cantidad de personas en situación de pobreza multidimensional en cada región de Chile. Se observa que la Región Metropolitana experimenta el mayor crecimiento poblacional, con un aumento del 36,50% entre 2017 y 2025, seguida de Tarapacá (21,81%) y Antofagasta (23,59%). En contraste, las regiones con menor crecimiento relativo son Aysén (7,57%), Ñuble (11,14%) y Magallanes (11%).

En términos de pobreza multidimensional, la Región Metropolitana registra la mayor cantidad de personas en esta condición (87.355), seguida de Biobío (57.250) y La Araucanía (42.579), lo que indica desafíos significativos en el acceso a servicios y calidad de vida. Por otro lado, Magallanes y Aysén presentan las cifras más bajas, con 10.221 y 8.246 personas respectivamente.

En algunas regiones, se observa una correspondencia directa entre la inversión PROPIR 2025 y la densidad poblacional proyectada para ese año. La Región Metropolitana de Santiago, Biobío y Los Lagos, que presentan una alta densidad poblacional, concentran también los mayores montos de inversión. Sin embargo, esta relación no se mantiene en todos los casos. Por ejemplo, la Región de Los Ríos, con 263.279.097 miles de pesos, recibe una inversión mayor que otras regiones con mayor densidad y crecimiento poblacional, como Antofagasta, lo que sugiere que otros factores además de la población influyen en la distribución de los recursos.

```{r, tab.cap=NULL}

#Esta es la tabla de las poblaciones, aquí ocupo las dos bases
#para poder ver aquellas comunas que no tengan inversión.



tab_poblacion_nac <- PROYECCIONES_POBmulti %>%
  group_by(RegionAB) %>%
  summarise(
    "Población 2017" = sum(TOTAL2017), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)

  )


tab_monto_nac <- BASE %>%
  select(RegionAB, `Monto 2025`) %>%
  group_by(RegionAB) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_nac <- left_join(tab_poblacion_nac,tab_monto_nac, by = "RegionAB")  %>% 
  mutate(RegionAB = factor(RegionAB, levels = rev(orden_regiones))) %>% 
arrange(RegionAB) %>% 
  filter(RegionAB != "INTERREGIONAL")




tab_resumen_nac %>%
  mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), 
         `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
         Monto2025 = scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", 
        col.names = c("Región", "Población 2017", "Población 2025 (*)", 
                      "Crec/Decrec de población 2017 al 2025 (%)", 
                      "N° de personas en situación de pobreza multidimensional (**)", 
                      "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  footnote(general = "Tabla 1: Poblaciones en regiones de Chile. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022", general_title = "")
  
```

```{r, fig.cap= NULL}


tabREG_CAT <- BASE %>%
  group_by(RegionAB, Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep") %>%
  mutate(RegionAB = factor(RegionAB, levels = orden_regiones)) %>%
  arrange(RegionAB, Categoría)


ggplot(tabREG_CAT, aes(x = RegionAB, y = TotalCat, fill = Categoría)) +
  facet_wrap(~Categoría, scales = "free_y", nrow = 1, , labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) + 
  geom_bar(stat = "identity", position = "stack", width = 0.6) + 
  geom_text(aes(label = scales::comma(TotalCat, big.mark = ".", decimal.mark = ",")), 
            hjust = -0.1, color = "black", size = 3) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    limits = function(x) {
      if ("Arrastre" %in% tabREG_CAT$Categoría) {
        c(0, 599565751)  
      } else {
        NULL  
      }
    }
  ) + 
  labs(
    caption = "Figura 2 : Inversión PROPIR 2025 desglosada por proyectos nuevos y de arrastre. \n Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria",
    title = "Inversión 2025 por Región y Clasificación del Proyecto (Arrastre y Nuevo)",
    x = "",
    y = "Inversión PROPIR 2025 (miles de pesos)"
  ) +
  scale_fill_manual(values = alpha(c("cornsilk4", "darkblue"), .7)) +
  theme_minimal() +  
  theme(panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.ticks.y = element_blank(),
    legend.title = element_blank(),  
    legend.position = "none",
    strip.background = element_rect(color = "black", linewidth = 1),
    strip.text = element_text(size = 10),
     plot.caption = element_text(hjust = -2, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-80)),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20))) +
  coord_flip()



```

```{r, fig.cap=NULL}

tab_eje_ministerial_cat_nac <- BASE %>%
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )



colores <- c(
  "Integración territorial, conectividad y movilidad" = "#155E95",
  "Desarrollo Productivo, Social, Cultural y Científico" = "#98D8EF",
  "Seguridad Ciudadana y ante desastres naturales y emergencias" = "#4C7B8B",
  "Seguridad hídrica" = "#F4EDD3"
)




ggplot(tab_eje_ministerial_cat_nac, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    title = "Inversión 2025 por clasificación de proyecto (arrastre y nuevo) y Eje Ministerial \n a nivel Nacional", 
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 3: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales. \n Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(
      label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 2.5, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30))) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE)) + 
  scale_y_continuous(
  labels = label_number(scale = 1e-6, suffix = "M"),
  expand = expansion(mult = c(0, 0.3)) 
)  




```

```{r}
tab2 <- BASE %>%
  group_by(RegionAB, Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")%>% mutate(
    RegionAB = factor(RegionAB, levels = orden_regiones_tab)
  ) %>% arrange(RegionAB)



#tab2 %>%
#  mutate(TotalCat = scales::comma(TotalCat, #big.mark = ".", decimal.mark = ",")) %>%
#  kable(caption = paste(" Resúmen del monto #presupuestario de 2025 por región y categoría de #proyecto"), col.names = c("Región","Categoría #Proyecto","Monto 2025")) %>%
#  kable_styling(bootstrap_options = c("striped", #"hover"), full_width = F)
```

```{r}

tab_servicios <- BASE %>%
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )


tab_servicios$Servicio <- reorder(tab_servicios$Servicio, tab_servicios$P2025)

#ggplot(tab_servicios, aes(x = Servicio, y = #P2025, fill = Servicio)) +
#  geom_bar(stat = "identity", width = 0.6) + 
#  geom_text(aes(
#    label = paste0(comma(P2025, big.mark = ".", #decimal.mark = ","), "\n", round(porcentaje, 1), #"%"),  
#    vjust = -0.5, 
#    size = 4, color = "black", fontface = "bold" # 
#  )) +
#  labs(
#    x = "Servicio", 
#    y = "Montos (miles de pesos)"
#  ) +
#  scale_y_continuous(limits = c(0, #max(tab_servicios$P2025) * 1.1), labels = #label_number(scale = 1e-6, suffix = "M")) +  
#  scale_fill_viridis(discrete = TRUE) + 
#  theme_minimal() +  
#  theme(legend.position = "none") 
```

```{r, fig.cap=NULL}



colores_servicios <- c("DV" = "#000957", "DGC" = "#155E95", "SSR" = "#4C585B","DOH" = "#7E99A3", 
            "DAP" = "#344CB7", "DOP" = "#98D8EF", "DA" = "#C4D9FF", "DGA" ="#1A3A6E", 
            "DP" = "#537895","ING" = "#A1BBCF", "OTROS" ="#D9ECFF", "SISS" ="#7B8FA6")


SERVICIOS_NAC <- BASE %>%
  group_by(SERVICIOS_A) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,3))


ggplot(SERVICIOS_NAC , aes(x = reorder(SERVICIOS_A, -Monto2025), y = Monto2025, fill = SERVICIOS_A)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP a nivel nacional",
       x = "Servicios",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 4: Inversión 2025 para los servicios asociados al MOP. Fuente: Elaboración propia a partir de los datos del \n Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA, DP, SISS e INH.") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_NAC$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme( panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    legend.position = "none", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 20, l =-40)))



otros_data <- BASE %>%
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto / sum(Monto) * 100,3)) %>% 
  filter(Servicio %in% c("INH", "SISS", "DP", "DGA", "DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )




kable(otros_data, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  footnote(general = "Tabla 2: Servicios agrupados en 'Otros', los cuáles incluyen DA, DGA, DP, SISS e INH. Fuente: tabla construída a partir de los datos del Departamento de Gestión Presupuestaria", general_title = "") 


```

```{r, fig.cap=NULL}


SH_NAC <- BASE %>%
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_NAC, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
  label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 2.7
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica a nivel nacional",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 5: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al eje ministerial de Seguridad Hídrica. \nFuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85)),
    panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
    plot.title = element_text(size = 10, hjust = 1, face = "bold", margin = margin(b = 20)) ) +
  expand_limits(y = c(0, max(SH_NAC$porcentaje) + 5))



```

## Arica y Parinacota

```{r, fig.cap= NULL}
#Tabla para Arica y Parinacota por categoría de proyecto


tabAyP_CAT <- BASE %>% filter(RegionAB == "ARICA Y PARINACOTA") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")



```

```{r}
#ggplot(BASE %>% filter(RegionAB == "ARICA Y PARINACOTA"), aes(x = #Servicio, y = `Monto 2025`)) + 
#  geom_bar(stat = "identity", position = "stack") + 
#  scale_y_continuous(labels =  label_number(scale = 1e-6, suffix #= "M")) + 
#  labs(
#    title = "Monto presupuestario de 2025 para la región de Arica #y #Parinacota por Servicio MOP",
#    subtitle = "Distribución del monto presupuestario de 2025 por #los #12 servicios MOP en la región de Arica y Parinacota",
#    x = "Servicio MOP",
#    y = "Monto 2025 (miles de pesos)") +
#  theme_minimal() +
#  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, fig.cap=NULL}

SERVICIOS_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DGA","DGC") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_AYP , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Arica y Parinacota",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)", caption = "Figura 6: Inversión 2025 para los servicios asociados al MOP para la Región de Arica y Parinacota. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \ncomprende los servicios DAP, DGA y DGC."
) +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_AYP$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),  
    legend.position = "none",
        plot.title = element_text(size = 12, face = "bold", hjust = 1.1, margin = margin(b = 20)),
        plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-20)))



otros_data_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DGA","DGC")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )


kable(otros_data_AYP, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 3: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP, DGA y DGC. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria", general_title = "")

```

```{r, fig.cap=NULL}

tab_eje_ministerial_cat_AyP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )




ggplot(tab_eje_ministerial_cat_AyP, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)",
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo) y Eje Ministerial\n para la Región de Arica y Parinacota",
    fill = "",
    caption = "Figura 7: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \nArica y Parinacota. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje,2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
  scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
  labels = label_number(scale = 1e-6, suffix = "M"),
  expand = expansion(mult = c(0, 0.3)) 
)


```

```{r, fig.cap = NULL}

tab_poblacion_AyP <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = sum(TOTAL2017), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)

  )



tab_monto_AyP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))

  

tab_resumen_AyP <- left_join(tab_poblacion_AyP,tab_monto_AyP, by = "NombreComuna")


tab_resumen_AyP %>%
  mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025", "Crec/Decrec (%) de población 2017 al 2025", "N°de personas en situación de pobreza multidimensional", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  footnote(general = "Tabla 4: Poblaciones en la Región de Arica y Parinacota. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")
```

## Tarapacá

```{r}
#Tabla Tarapacá por categoría de proyecto

tabTPCA_CAT <- BASE %>% filter(RegionAB == "TARAPACÁ") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")

```

```{r, fig.cap = NULL}
SERVICIOS_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DGA","DGC","DOP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_TARAPACA , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")),  
          vjust = -0.5, 
          size = 3, 
          color = "black", 
          fontface = "bold")+
  labs(title = "Distribución de Inversión 2025 por servicios MOP de la región de Tarapacá",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 8: Inversión 2025 para los servicios asociados al MOP para la Región de Tarapacá. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. \nNota: La categoría 'Otros' comprende los servicios DAP, DGA, DGC y DOP.") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_TARAPACA$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
         plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-20))
)



otros_data_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DGA","DGC","DOP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_TARAPACA, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 5: Servicios agrupados en 'Otros', los cuáles incluyen DA, DGA, DP, SISS e INH. Fuente: tabla construída a partir de los datos del Departamento de Gestión Presupuestaria", general_title = "") 


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_TPCA <- BASE %>%
  filter(RegionAB == "TARAPACÁ" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )




ggplot(tab_eje_ministerial_cat_TPCA, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
     title = "Inversión 2025 por clasificación de proyecto (arrastre y nuevo) y eje ministerial \npara la Región de Tarapacá",
    caption = "Figura 9: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región \nde Tarapacá. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
  scale_fill_manual(values = colores)+ 
  theme(caption = "Figura 9: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \n Tarapacá. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria.",
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30)))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )





```

```{r}

tab_poblacion_Tarapaca <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "TARAPACÁ") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
summarise(
    "Población 2017" = sum(TOTAL2017), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
  "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_Tarapaca <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_Tarapaca <- left_join(tab_poblacion_Tarapaca,tab_monto_Tarapaca, by = "NombreComuna")

tab_resumen_Tarapaca %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 6: Poblaciones e Inversiones 2025 en la Región de Tarapacá. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")


```

```{r, fig.cap=NULL}


SH_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_TARAPACA, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 2.7
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Tarapacá",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 10: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al eje ministerial de Seguridad Hídrica \npara la Región de Tarapacá. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
   plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_TARAPACA$porcentaje) + 5))



```

## Antofagasta

```{r}

#Tabla para Antofagasta por categoría de proyecto

tabAntof_CAT <- BASE %>% filter(RegionAB == "ANTOFAGASTA") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")

```

```{r}

#Antof 8 servicios

tab_servicios_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )


colores <- c(
  "Integración territorial, conectividad y movilidad" = "#155E95",
  "Desarrollo Productivo, Social, Cultural y Científico" = "#98D8EF",
  "Seguridad Ciudadana y ante desastres naturales y emergencias" = "#4C7B8B",
  "Seguridad hídrica" = "#F4EDD3"
)

```

```{r, fig.cap = NULL}
SERVICIOS_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DOP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_ANTOF , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Antofagasta",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 11: Inversión 2025 para los servicios asociados al MOP para la Región de Antofagasta. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA y DOP") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_ANTOF$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))



)



otros_data_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DOP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_ANTOF, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 7: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP, DGA y DGC para la Región de Antofagasta. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")

```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )






ggplot(tab_eje_ministerial_cat_ANTOF, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo)\n para la Región de Antofagasta",
    caption = "Figura 12: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \nAntofagasta. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}

tab_poblacion_Antofagasta <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ANTOFAGASTA") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
"Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))




tab_monto_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))



tab_resumen_antof <- left_join(tab_poblacion_Antofagasta, tab_monto_ANTOF, by = "NombreComuna")



tab_resumen_antof  %>%  
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 8: Poblaciones e Inversiones 2025 en la Región de Antofagasta. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")


```

```{r, fig.cap = NULL}


SH_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_ANTOF, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Antofagasta",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 13: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de Antofagasta. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))

  ) +
  expand_limits(y = c(0, max(SH_ANTOF$porcentaje) + 5))



```

## Atacama

```{r}
#Tabla Atacama por categoría de proyecto

tabATCMA_CAT <- BASE %>% filter(RegionAB == "ATACAMA") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")



```

```{r}

#Gráfico para Tarapacá por categoría de proyecto

tabATCMA_CAT <- BASE %>% 
  filter(RegionAB == "ATACAMA") %>%
  group_by(NombreComuna, Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")

```

```{r}

#Servicios desagregados en ATACAMA

tab_servicios_ATCMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )


```

```{r, fig.cap=NULL}

SERVICIOS_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DOP", "SSR") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_ATACAMA , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 2), nsmall = 1, decimal.mark = ","), "%)")
    ), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por Servicios MOP para la Región de Atacama",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 14: Inversión 2025 para los servicios asociados al MOP para la Región de Atacama. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. \nNota: La categoría 'Otros' comprende los servicios DAP, DGA y DOP.") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_ATACAMA$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),  
    legend.position = "none",
        plot.title = element_text(size = 12, face = "bold", hjust = 1.1, margin = margin(b = 20)),
        plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)))



otros_data_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DOP", "SSR")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_ANTOF, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 9: Servicios agrupados en 'Otros', los cuáles incluyen DAP, DGA y DOP. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria", general_title = "") 


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_ATCMA <- BASE %>%
  filter(RegionAB == "ATACAMA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )





ggplot(tab_eje_ministerial_cat_ATCMA, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
     title = "Inversión 2025 por clasificación de proyecto (arrastre y nuevo) y Eje Ministerial \npara la Región de Atacama",
    caption = "Figura 15: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región \nde Atacama. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
  scale_fill_manual(values = colores)+ 
  theme(caption = "Figura 9: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \n Tarapacá. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria.",
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r, fig.cap = NULL}


tab_poblacion_Atacama <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ATACAMA") %>% 
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
summarise(
    "Población 2017" = sum(TOTAL2017), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_Atacama <-  BASE %>%
  filter(RegionAB == "ATACAMA") %>%  
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_Atacama <- left_join(tab_poblacion_Atacama, tab_monto_Atacama, by = "NombreComuna")



tab_resumen_Atacama %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 10: Poblaciones e Inversiones 2025 en la región de Atacama. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")





```

```{r, fig.cap = NULL}


SH_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_ATACAMA, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
            label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Atacama",
    x = NULL,
    y = "Porcentaje del monto total",
     caption = "Figura 16: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de Atacama. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
   panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_ATACAMA$porcentaje) + 5))



```

## Coquimbo

```{r}


tabCOQ_CAT <- BASE %>% filter(RegionAB == "COQUIMBO") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}

#Hay menos servicios a nivel regional

tab_servicios_COQ <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_COQ <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DP", "DOP","DGA","DAP","DA") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_COQ , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Coquimbo",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 17: Inversión 2025 para los servicios asociados al MOP. Fuente: Elaboración propia a partir de los datos del \n Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DP, DOP, DGA, DAP y DA."
) +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_COQ$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 20, l =-40))
)



otros_data_COQUIMBO <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DP", "DOP","DGA","DAP","DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_COQUIMBO, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%  footnote(general = "Tabla 11: Servicios agrupados en 'Otros', los cuáles incluyen DA, DAP, DGA,DOP, DP. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria", general_title = "") 

```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_COQ <- BASE %>%
  filter(RegionAB == "COQUIMBO" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )



ggplot(tab_eje_ministerial_cat_COQ, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    
title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región de Coquimbo", 
caption = "Figura 18: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nCoquimbo. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r, fig.cap = NULL}

tab_poblacion_Coquimbo <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "COQUIMBO") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
  "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_Coquimbo <-  BASE %>%
  filter(RegionAB == "COQUIMBO") %>%   
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_Coquimbo <- left_join(tab_poblacion_Coquimbo,tab_monto_Coquimbo, by = "NombreComuna")




tab_resumen_Coquimbo %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 12: Poblaciones e Inversiones 2025 en la región de Coquimbo. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")



```

```{r, fig.cap = NULL}


SH_COQUIMBO <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_COQUIMBO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
            label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Coquimbo",
    x = NULL,
    caption = "Figura 19: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad \nHídrica para la Región de Coquimbo. Fuente: Elaboración propia a partir de datos del Departamento de \nGestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición.",
    y = "Porcentaje del monto total"
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_COQUIMBO$porcentaje) + 5))



```

## Valparaíso

```{r}
#Tabla Valparaíso por categoría de proyecto

tabVALPO_CAT <- BASE %>% filter(RegionAB == "VALPARAÍSO") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")

```

```{r}

#Gráfico para valparaíso por categoría de proyecto

tabVALPO_CAT <- BASE %>% 
  filter(RegionAB == "VALPARAÍSO") %>%
  group_by(NombreComuna, Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")

```

```{r}

#Hay menos servicios a nivel regional

tab_servicios_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )
```

```{r, fig.cap=NULL}
SERVICIOS_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DP", "DA") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_VALPO , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje,3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Valparaíso",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 20: Inversión 2025 para los servicios asociados al MOP para la Región de Valparaíso. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA y DP") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_VALPO$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40)))



otros_data_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto / sum(Monto) * 100,3)) %>% 
  filter(Servicio %in% c("DP", "DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.0001)
  )



kable(otros_data_VALPO, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
    footnote(general = "Tabla 13: Servicios agrupados en ‘Otros’, los cuáles incluyen DA y DP para la Región de Valparaíso. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")

```

```{r, fig.cap=NULL}

tab_eje_ministerial_cat_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )




ggplot(tab_eje_ministerial_cat_VALPO, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    title = "Asignación de la Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial para la \nRegión de Valparaíso",
    caption = "Figura 21: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales \npara la Región de Valparaíso. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)))  +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}



tab_poblacion_Valparaiso <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "VALPARAÍSO") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
    "Crec/Decrec de población 2017 al 2025" = 
      (first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / 
      first(TOTAL2017) * 100,
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_Valparaiso <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))

tab_resumen_Valparaiso <- left_join(tab_poblacion_Valparaiso,tab_monto_Valparaiso, by = "NombreComuna")

tab_resumen_Valparaiso %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 14: Poblaciones e Inversiones 2025 en la región de Valparaíso. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")



```

```{r, fig.cap = NULL}


SH_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_VALPO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
            label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Valparaíso",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 22: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al eje ministerial de Seguridad Hídrica \npara la Región de Valparaíso. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
    
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_VALPO$porcentaje) + 5))



```

## Metropolitana de Santiago

```{r}
#Tabla RM por categoría de proyecto

tabRM_CAT <- BASE %>% filter(RegionAB == "METROPOLITANA") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}

tab_servicios_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DP", "DGA","INH","SISS","DAP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_RM , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la \nRegión Metropolitana de Santiago",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 23: Inversión 2025 para los servicios asociados al MOP para la \nRegión Metropolitana de Santiago. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DAP, DGA, DP, INH y SISS ") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_RM$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
      plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))


)



otros_data_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DP", "DGA","INH","SISS","DAP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_RM, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 15: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP, DGA, DP, INH y SISS para la Región Metropolitana de Santiago. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap=NULL}

tab_eje_ministerial_cat_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_RM, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región Metropolitana de Santiago",     
caption = "Figura 24: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región \nMetropolitana de Santiago. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
 theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}

PROYECCIONES_POBmulti <- PROYECCIONES_POBmulti %>% mutate(NombreComuna = case_when(NombreComuna == "TILTIL" ~ "TIL TIL", TRUE ~ NombreComuna))


tab_poblacion_Metropolitana <- PROYECCIONES_POBmulti %>%
  filter(RegionAB=="METROPOLITANA") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
   "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),
"Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_RM <- left_join(tab_poblacion_Metropolitana,tab_monto_RM, by = "NombreComuna")


tab_resumen_RM <- tab_resumen_RM %>%
  mutate(
    Monto2025 = case_when(
      NombreComuna == "Pirque" ~ 0, 
      TRUE ~ Monto2025        
    )
  )





tab_resumen_RM %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 16: Poblaciones e Inversiones 2025 en la región Metropolitana de Santiago. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")






```

```{r, fig.cap = NULL}


SH_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_RM, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") )
    ,
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión Metropolitana de Santiago",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 25: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región metropolitana de Santiago. Fuente: Elaboración propia a partir de datos del Departamento de Gestión \nPresupuestaria. Nota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_RM$porcentaje) + 5))



```

## Libertador del General Bernardo O'higgins

```{r}
#Tabla LGBO por categoría de proyecto

tabLGBO_CAT <- BASE %>% filter(RegionAB == "O'HIGGINS") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}

tab_servicios_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DA","DGA","DOP","DP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)



ggplot(SERVICIOS_LGBO , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de O'higgins",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 26: Inversión 2025 para los servicios asociados al MOP para la Región de O'higgins. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DAP, \nDGA, DOP y DP") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_LGBO$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)))



otros_data_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DA","DGA","DOP","DP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_LGBO, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "Tabla 17: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DAP, DGA, DOP y DP para la Región de O'higgins. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )




ggplot(tab_eje_ministerial_cat_LGBO, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
  x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo)\n y Eje Ministerial para la Región de O'higgins",
    caption = "Figura 27: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \nO'higgins. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)))  +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}



tab_poblacion_OHiggins <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
 "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_Ohiggins <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))



tab_resumen_LGBO <- left_join(tab_poblacion_OHiggins,tab_monto_Ohiggins, by = "NombreComuna")




tab_resumen_LGBO %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 18: Poblaciones e Inversiones 2025 en la región del Libertador Bernardo O'higgins. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")


```

```{r, fig.cap = NULL}


SH_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_LGBO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de O'higgins",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 28: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de O'higgins. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_LGBO$porcentaje) + 5))



```

## Maule

```{r}
#Tabla MAULE por categoría de proyecto

tabMAULE_CAT <- BASE %>% filter(RegionAB == "MAULE") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}

# 8 SERVICIOS EN MAULE

tab_servicios_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DGC") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_MAULE , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje,3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región del Maule",
y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 29: Inversión 2025 para los servicios asociados al MOP de la Región del Maule. Fuente: Elaboración propia a partir de los datos del \n Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA y DGC.",
       x = "") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_MAULE$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        
panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 20, l =-40)))



otros_data_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DGC")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_MAULE, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 19: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DGC para la Región deL Maule. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_MAULE <- BASE %>%
  filter(RegionAB == "MAULE" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )





ggplot(tab_eje_ministerial_cat_MAULE, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región del Maule",  
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 30: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región del Maule. \n Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria.") + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40)))  +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}



tab_poblacion_Maule <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "MAULE") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017), 
    "Población 2025" = first(`Suma de Poblacion 2025`),  
    "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),
 
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_Maule <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))



tab_resumen_maule <- left_join(tab_poblacion_Maule,tab_monto_Maule, by = "NombreComuna")




tab_resumen_maule %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 20: Poblaciones e Inversiones 2025 en la Región del Maule. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")





```

```{r, fig.cap = NULL}


SH_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_MAULE, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica\n para la Región del Maule",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 31: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región del Maule. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))

  ) +
  expand_limits(y = c(0, max(SH_MAULE$porcentaje) + 5))




```

## Ñuble

```{r}
#Tabla Nuble por categoría de proyecto

tabNUBLE_CAT <- BASE %>% filter(RegionAB == "ÑUBLE") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}
tab_servicios_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DAP","DOP","DGC") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_NUBLE , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje,3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región del Ñuble",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 32: Inversión 2025 para los servicios asociados al MOP par la Región del Ñuble. Fuente: Elaboración propia a partir de los datos del \n Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DAP, DOP y DGC.") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_NUBLE$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)),
 plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))

)



otros_data_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DAP","DOP","DGC") ) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_NUBLE, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 21: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DAP y DOP y DGC para la Región del Ñuble. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_NUBLE, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región del Ñuble",     
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 33: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región del \nÑuble. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}



tab_poblacion_Nuble <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ÑUBLE") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
 "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_NUBLE <- left_join(tab_poblacion_Nuble,tab_monto_NUBLE, by = "NombreComuna")
  




tab_resumen_NUBLE %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 22: Poblaciones e Inversiones 2025 en la región del Ñuble. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")


```

```{r, fig.cap = NULL}


SH_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_NUBLE, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión del Ñuble",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 34: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región del Ñuble. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_NUBLE$porcentaje) + 5))



```

## Bíobío

```{r}
tabBBIO_CAT <- BASE %>% filter(RegionAB == "BIOBÍO") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}
tab_servicios_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DAP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_BBIO , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región del Biobío",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
        caption = "Figura 35: Inversión 2025 para los servicios asociados al MOP para la Región deL Biobío. Fuente: Elaboración propia a partir \nde los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA y \nDAP") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_BBIO$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 20, l =-43))

)



otros_data_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DAP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_BBIO, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 23: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DAP para la Región del Biobío. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_BIOBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_BIOBIO, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región del Bíobío",
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 36: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región del \nBiobío. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}


tab_poblacion_Biobio <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "BIOBÍO") %>%  
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
"Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)
  )



tab_monto_BIOBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`)) %>% 
  mutate(NombreComuna = case_when(NombreComuna == "ALTO BIO BIO" ~ "ALTO BIOBIO", TRUE ~ NombreComuna) )



tab_resumen_BIOBIO <- left_join(tab_poblacion_Biobio,tab_monto_BIOBIO, by = "NombreComuna")



tab_resumen_BIOBIO %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 24: Poblaciones e Inversiones 2025 en la Región del BioBío. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")




```

```{r, fig.cap = NULL}


SH_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_BBIO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 2.8
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión del BioBío",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 37: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región del Biobío. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_BBIO$porcentaje) + 5))



```

## La Araucanía

```{r}
tabARAUC_CAT <- BASE %>% filter(RegionAB == "LA ARAUCANÍA") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}
tab_servicios_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100)  
  

```

```{r, fig.cap = NULL}

SERVICIOS_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DOP", "DAP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_ARAUC , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de La Araucanía",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 38: Inversión 2025 para los servicios asociados al MOP para la Región de La Araucanía. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DOP y \nDAP."
) +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_ARAUC$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)
))



otros_data_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DOP", "DAP") ) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_ARAUC, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "Tabla 25: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP, DGA y DGC para la Región de La Araucanía. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")



```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_ARAUC, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial\n para la región de La Araucanía",
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 39: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región \nde La Araucanía. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."


  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}



tab_poblacion_Araucania <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "LA ARAUCANÍA") %>%
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`,`Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_ARAUC <- left_join(tab_poblacion_Araucania,tab_monto_ARAUC, by = "NombreComuna")



tab_resumen_ARAUC %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 26: Poblaciones e Inversiones 2025 en la región de La Araucanía. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")


```

```{r, fig.cap = NULL}


SH_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_ARAUC, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de La Araucanía",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 40: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de La Araucanía. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_ARAUC$porcentaje) + 5))



```

## Los Ríos

```{r}
tabRIOS_CAT <- BASE %>% filter(RegionAB == "LOS RÍOS") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}
tab_servicios_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DOH", "DGA","DGC","DA") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_RIOS , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Los Ríos",
       caption = "Figura 27: Inversión 2025 para los servicios asociados al MOP para la Región de Los Ríos. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DOH, DGAM DGC y DA.",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_RIOS$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) 




otros_data_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DOH", "DGA","DGC","DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_RIOS, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "Tabla 28: Servicios agrupados en ‘Otros’, los cuáles incluyen DOH, DGAM DGC y DA para la Región de Los Ríos. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")




```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_RIOS, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región de Los Ríos", 
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 42: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región \nde Los Ríos. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje,2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}


tab_poblacion_LosRios <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "LOS RÍOS") %>%
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)
  )



tab_monto_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_RIOS <- left_join(tab_poblacion_LosRios,tab_monto_RIOS, by = "NombreComuna")





tab_resumen_RIOS %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 29: Poblaciones e Inversiones 2025 en la región de Los Ríos. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")


```

```{r, fig.cap = NULL}


SH_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_RIOS, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Los Ríos",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 43: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de Los Ríos. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))

  ) +
  expand_limits(y = c(0, max(SH_RIOS$porcentaje) + 5))


```

## Los Lagos

```{r}
tabLAGOS_CAT <- BASE %>% filter(RegionAB == "LOS RÍOS") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}
tab_servicios_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DOH") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)



ggplot(SERVICIOS_LAGOS , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje,3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3.5, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Los Lagos",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 44: Inversión 2025 para los servicios asociados al MOP para la Región de Los Lagos. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA \ny DOH") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_LAGOS$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))
)



otros_data_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in%  c("DA", "DGA","DOH")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje,3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_LAGOS, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "Tabla 30: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DOH para la Región de Los Lagos. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_LAGOS, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Los Lagos", 
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 45: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \nLos Lagos. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."


  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}



tab_poblacion_LosLagos <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "LOS LAGOS") %>%
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),
    "Población 2025" = first(`Suma de Poblacion 2025`),
"Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))




tab_monto_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_LAGOS <- left_join(tab_poblacion_LosLagos,tab_monto_LAGOS, by = "NombreComuna")





tab_resumen_LAGOS %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 31: Poblaciones e Inversiones 2025 en la Región de Los Lagos. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")



```

```{r, fig.cap = NULL}


SH_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_LAGOS, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Los Lagos",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 46: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de Los Lagos. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_LAGOS$porcentaje) + 5))



```

## Aysén del General Carlos Ibáñez del Campo

```{r}
tabAYSEN_CAT <- BASE %>% filter(RegionAB == "AYSÉN") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")

```

```{r}
tab_servicios_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DGC","DP","DOP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_AYSEN , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Aysén \n del General Carlos Ibáñez del Campo",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 47: Inversión 2025 para los servicios asociados al MOP para la Región de Aysén del General Carlos Ibáñez del \nCampo. Fuente: Elaboración propia a partir de los datos del  Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' comprende los servicios DA, DGA, DGC, DP y DOP."
) +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_AYSEN$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))
)



otros_data_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DGC","DP","DOP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_AYSEN, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "Tabla 32: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA, DGC, DP y DOP para la Región de Aysén del General Carlos Ibáñez del Campo. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_AYSEN, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la Región de Aysén del General Carlos Ibáñez del Campo.",     
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
caption = "Figura 48: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \nAysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión \nPresupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}



tab_poblacion_Aysen <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "AYSÉN") %>%
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)
  )



tab_monto_Aysen <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`)) %>% 
    mutate(NombreComuna = case_when(NombreComuna == "COIHAIQUE" ~ "COYHAIQUE", TRUE ~ NombreComuna) )

tab_resumen_Aysen <- left_join(tab_poblacion_Aysen,tab_monto_Aysen, by = "NombreComuna")



tab_resumen_Tarapaca %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 33: Poblaciones e Inversiones 2025 en la Región de Aysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")



```

```{r, fig.cap = NULL}


SH_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_AYSEN, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Aysén del General Carlos Ibáñez del Campo",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 49: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de Aysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia a partir de datos del \nDepartamento de Gestión Presupuestaria. Nota: La categorización del programa dipres fue realizada en cuatro clases. \nLa primera es 'Consumo Humano' que está compuesta por los programas pertenecientes a: agua potable rural \nsemi-concentrada y agua potable rural concentrada. La segunda es 'Riego' que agrupa: grandes obras de riego, \nconservación de obras de riego, explotación de obras de riego obras de riego. La categoría 'Estudios y otros' reune los \nsiguientes programas asociados a la Dipres: estudio básico, estudio y otros. \nFinalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de recursos hídricos y \nampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_AYSEN$porcentaje) + 5))



```

## Magallanes y de la Antártica Chilena

```{r}
tabMAG_CAT <- BASE %>% filter(RegionAB == "MAGALLANES") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")


```

```{r}
tab_servicios_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )

```

```{r, fig.cap = NULL}
SERVICIOS_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DGC","DOH") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_MAG , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3.5, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Magallanes \n y de la Antártica Chilena",
       x = "",
       y = "Inversión PROPIR 2025 (miles de pesos)",
       caption = "Figura 50: Inversión 2025 para los servicios asociados al MOP para la Región de Magallanes y de la Antártica Chilena. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \ncomprende los servicios \nDA, DGA, DGC y DOH."
) +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_MAG$Monto2025) * 1.3), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))

)



otros_data_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DGC","DOH")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_MAG, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "Tabla 34: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA, DGC y DOH para la Región de Magallanes y de la Antártica Chilena. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")


```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_MAG, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Magallanes y de la Antártica Chilena",    
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    fill = "",
    caption = "Figura 51: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región de \nMagallanes y de la Antártica Chilena. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión\n Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}



tab_poblacion_Magallanes <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "MAGALLANES") %>%
  select(NombreComuna, TOTAL2017, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2017" = first(TOTAL2017),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec de población 2017 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(TOTAL2017)) / first(TOTAL2017) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_MAG <- left_join(tab_poblacion_Magallanes,tab_monto_MAG, by = "NombreComuna")




tab_resumen_MAG %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2017` = scales::comma(`Población 2017`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), Monto2025 =  scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) %>%
  kable("html", col.names = c("Comuna", "Población 2017", "Población 2025 (*)", "Crec/Decrec (%) de población 2017 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión PROPIR 2025")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "Tabla 35: Poblaciones e Inversiones 2025 en la Región de Magallanes y de la Antártica Chilena. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión PROPIR 2025 corresponden a comunas que forman parte de proyectos intercomunales.", general_title = "")

```

```{r, fig.cap = NULL}


SH_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_MAG, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nRegión de Magallanes y de la Antártica Chilena",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 52:  Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la Región de Magallanes y de la Antártica Chilena. Fuente: Elaboración propia a partir de datos del \nDepartamento de Gestión Presupuestaria. Nota: La categorización del programa dipres fue realizada en cuatro clases. \nLa primera es 'Consumo Humano' que está compuesta por los programas pertenecientes a: agua potable rural \nsemi-concentrada y agua potable rural concentrada. La segunda es 'Riego' que agrupa: grandes obras de riego, \nconservación de obras de riego, explotación de obras de riego obras de riego. La categoría 'Estudios y otros' reune los \nsiguientes programas asociados a la Dipres: estudio básico, estudio y otros. \nFinalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de recursos hídricos y \nampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_MAG$porcentaje) + 5))



```

## Proyectos Interregionales

```{r}
tabINTERREGIONAL_CAT <- BASE %>% filter(RegionAB == "INTERREGIONAL") %>%
  group_by(NombreComuna,Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep")



```

```{r}
tab_servicios_INTERREGIONAL <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>% 
  group_by(Servicio) %>%
  summarise(P2025 = sum(`Monto 2025`)) %>%
  mutate(
    total = sum(P2025),  
    porcentaje = P2025 / total * 100  
  )


```

```{r, fig.cap = NULL}
SERVICIOS_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DAP","DP","DOH") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto2025 / sum(Monto2025) * 100)


ggplot(SERVICIOS_INTER , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), "\n", round(Porcentaje,3), "%")
    ), vjust = -0.5, size = 3.5, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para Proyectos Interregionales",
       x = "",
       y = "Inversión PROPIR 2025",
  caption = "Figura 53: Inversión 2025 para los servicios asociados al MOP para los Proyectos Interregionales. Fuente: Elaboración propia \na partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios \nDA, DAP, DOH y DP." ) +

    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_INTER$Monto2025) * 1.3), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45)))



otros_data_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DAP","DP","DOH")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_INTER, "html", col.names = c("Servicio", "Inversión PROPIR 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "Tabla 36: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DAP, DOH y DP para los Proyectos Interregionales. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.", general_title = "")



```

```{r, fig.cap = NULL}

tab_eje_ministerial_cat_INTERREGIONAL <- BASE %>%
  filter(RegionAB == "INTERREGIONAL" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )


ggplot(tab_eje_ministerial_cat_INTERREGIONAL, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyecto de Arrastre", "Nuevo" = "Proyecto Nuevo"))) +
  labs(
    x = "", 
    y = "Inversión PROPIR 2025 (miles de pesos)", 
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo) y Eje Ministerial \n para los Proyectos Interregionales",
    fill = "",
    caption = "Figura 54: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para los Proyectos \nInterregionales. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(
      label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)

    ), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45))) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r, fig.cap = NULL}


SH_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = (monto2025 / sum(monto2025)) * 100
  )

ggplot(SH_INTER, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para los \nProyectos Interregionales",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 55: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara Proyectos Interregionales. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrada y agua potable rural concentrada. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85))
  ) +
  expand_limits(y = c(0, max(SH_INTER$porcentaje) + 5))



```

## Conclusiones

## Bibliografía
